# Updater / Installer

## Структура скрипта

Скрипт должен запускаться при подключении флешки к машине. Семантически скрипт разделён на следующие части, должные запускаться по порядку.

### Pre script
1. Монтирование флешки
2. Лог формата флешки, Остатка свободного места.
3. Проверка на чтение и запись. При провале любой из проверок отменять скрипт.
	- На чтение: попытка прочесть файл disk/synapse-key
	- На запись: попытка удалить затем создать директорию disk/synapse-log
4. в disk/synapse-log создать следующую структуру:
```
synapse-log/
├─ logs/
│  ├─ synapse/
│  ├─ installer/
│  │  ├─ log.txt
├─ cache/
├─ manual-selected/
├─ current-states
```

>TODO Вероятно следует проработать отмену запуска Install

>TODO утерян смысл директории disk/synapse-log/current-states

### Install
1. Проверить наличие disk/get-synapse-log:

В файле может быть указан список путей относительно корня synapse. Необходимо скопировать файлы по указанным путям из synapse в disk/synapse-log/manual-selected/ с сохранением относительных путей

2. disk/synapse-log/cache/ скопировать dirty cache, а также записать htop:
	- Общий CPU по всем процессам
	- RAM
	- Данные по топ 10 процессам по потреблению CPU

3. Копировать в disk/synapse-log/logs/synapse/ логи synapse, пока хватит места на флешке. Начинать с самых последних логов

4. Возможно здесь будет шифрование disk/synapse-log

5. disk/synapse-log сжать в .tar и в таком виде оставить на флешке

### Update
1. Узнать текущую версию synapse. Создать новую директорию с указанием версии srv/synapse-{version}, копировать туда srv/synapse.
2. Остановить сервис synapse
3. Скопировать файлы из disk/updater в srv/synapse c заменой.
4. Перезапустить сервис synapse

### Post
