# Updater / Installer

## Структура скрипта

Скрипт должен запускаться при подключении флешки к машине. Семантически скрипт разделён на следующие части, должные запускаться по порядку.

### Pre script
1. Монтирование флешки

2. Лог формата флешки, Остатка свободного места.

3. Проверка на чтение и запись. При провале любой из проверок отменять скрипт.
	- На чтение: попытка перезаписать в project/synapse-key содержимое disk/synapse-key
	- На запись: проверка начилия прав на запись disk/synapse-key

### Install
1. создать директорию disk/synapse-log-YYYYMMDD-hhmmss (далее disk/synapse-log)

2. в disk/synapse-log создать следующую структуру:
```
synapse-log/
|- dirty-cache/
|- manual-selected.tar.gz
|- synapse-logs.tar.gz
|- hostid
|- htop
```

3. В файл disk/synapse-log/hostid записать вывод скрипта hostid

4. В disk/synapse-log/dirty-cache/ скопировать грязный файловый кэш

5. В файл disk/synapse-log/htop записать htop:
	- Общий CPU по всем процессам
	- RAM
	- Данные по топ 10 процессам по потреблению CPU

6. Проверить наличие disk/get-synapse-log:
В файле может быть указан список путей относительно корня synapse. Необходимо скопировать файлы по указанным путям из synapse в disk/synapse-log/manual-selected.tar.gz с сохранением относительных путей
	- В будущем get-synapse-log будет зашифрован

7. Копировать в disk/synapse-log/synapse-logs.tar.gz логи synapse, пока хватит места на флешке. Начинать с самых свежих логов

8. В будущем вышеуказанные архивы и htop должны будут шифроваться

### Update
1. Проверить наличие файла disk/synapse-update. Прочитать первый мегабайт в случае наличия.
2. Полученный мегабайт расшифровать и распаковать -> инсталяционный скрипт
3. Сверить deployid скрипта с deployid на хосте. deployid инсталятора должен быть больше на 1. Запустить скрипт в случае успешной проверки
